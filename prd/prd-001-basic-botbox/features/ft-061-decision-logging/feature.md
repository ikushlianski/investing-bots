# Feature: ft-061 - Signal Tracking and Decision Logging

**Status:** Proposed
**Priority:** P0 (Critical for debugging and optimization)
**Depends On:** ft-020-audit-logging, ft-100-bot-management, ft-091-risk-management-framework, ft-136-tradingview-charts-integration

## 1. Problem Statement

Traditional trading systems only log **executed trades**, creating a massive blind spot: you never know about signals that were generated but rejected. This makes it nearly impossible to answer critical questions:

- "Why didn't my bot enter when BTC hit support at $60k?" (Was there a signal? Was it rejected? Why?)
- "How many opportunities did I miss today because of position limits?"
- "Is my regime detector too aggressive? (Am I skipping good trades?)"
- "Did my bot see the rally coming but risk controls prevented entry?"

Without logging **every signal evaluation** (both accepted and rejected), you cannot:
1. Debug why bot didn't trade when conditions seemed right
2. Optimize filters (are they too strict? too loose?)
3. Backtest accurately (need all signals, not just trades)
4. Build confidence (understand bot's full decision-making process)

This feature establishes a comprehensive signal tracking system that logs **every potential trade opportunity**, the decision made, and the exact reason for acceptance or rejection.

## 2. Goals

- Log every signal generated by every strategy, regardless of outcome
- Capture the complete decision tree: signal â†’ validation â†’ risk check â†’ execution or rejection
- Provide visual representation of signals on charts (executed, rejected, missed opportunities)
- Enable deep analysis: "Show me all rejected signals in the last 30 days where rejection reason was 'max positions reached'"
- Support strategy optimization by revealing which filters eliminate the most opportunities

## 3. Core Concepts

### Signal vs Trade

**Signal:** A potential trading opportunity identified by a strategy
- Strategy conditions met (e.g., RSI < 30, price at support)
- Bot evaluates whether to act on it
- Outcome: Accepted (becomes trade) or Rejected (logged as missed opportunity)

**Trade:** An executed position
- Signal was accepted
- Passed all validation and risk checks
- Order placed on exchange

### Signal Lifecycle

```
1. Strategy Evaluation
   â†“
2. Signal Generated (if conditions met)
   â†“
3. Pre-Trade Validation
   â†“
4. Risk Management Check
   â†“
5. Decision: ACCEPT or REJECT
   â†“
6. If ACCEPT: Execute Trade
   If REJECT: Log as "Signal Not Taken"
```

## 4. User Stories

### US-001: View All Signals on Chart

**As a trader**, I want to see all generated signals (both taken and rejected) overlaid on a TradingView chart, so I understand my bot's complete decision-making history.

**Acceptance Criteria:**
- Chart displays price action with candlesticks
- Green markers: Signals that became trades (executed)
- Yellow markers: Signals that were rejected
- Red markers: Signals that failed validation
- Clicking a marker shows popup with full decision details
- Filter options: Show only executed / only rejected / all signals

**Visual Example:**
```
Chart:
Price: $60,000 â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€ (Green: Trade executed)
Price: $60,500 â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€ (Yellow: Rejected - max positions)
Price: $61,000 â”€â”€â”€â”€â”€â—‹â”€â”€â”€â”€â”€ (Red: Failed - insufficient capital)
```

### US-002: Signal Decision Log

**As a trader**, I want to see a detailed log of every signal evaluation, including the reason for rejection, so I can debug why my bot didn't enter when I expected it to.

**Acceptance Criteria:**
- Table view: Timestamp, Asset, Strategy, Signal Type (LONG/SHORT), Decision (Accepted/Rejected), Reason
- Expandable rows show full decision context:
  - Strategy conditions that triggered signal
  - Validation checks performed
  - Risk checks performed
  - Exact reason for rejection (if rejected)
- Filter by: Date range, Asset, Strategy, Decision outcome, Rejection reason
- Export to CSV for analysis

**Example Log Entry:**
```
Timestamp: 2024-10-27 14:35:22 UTC
Asset: BTC/USDT
Strategy: ST-002 Mean Reversion v1.0
Bot: BTC Range Bot
Signal Type: LONG
Decision: REJECTED

Signal Conditions Met:
âœ“ Price touched lower Bollinger Band ($60,050)
âœ“ RSI < 30 (RSI = 28)
âœ“ 1H candle closed inside BB ($60,150)
âœ“ Volume confirmation (1.2Ã— average)

Validation Checks:
âœ“ Market regime: Ranging (ADX = 17)
âœ“ Strategy enabled for this regime
âœ“ No conflicting positions in BTC/USDT

Risk Management Checks:
âœ“ Capital available ($8,500 of $10,000)
âœ“ Position size within limits
âœ— Max concurrent positions reached (6/6 active)

REJECTION REASON: Portfolio limit - Maximum 6 concurrent positions already open
â†’ Cannot open new position until one closes

Alternative Action: Signal logged for post-analysis
```

### US-003: Rejection Reason Analytics

**As a trader**, I want to see analytics on why signals are being rejected, so I can optimize my risk limits or identify if I'm missing too many opportunities.

**Acceptance Criteria:**
- Dashboard widget: "Signal Rejection Analysis (Last 30 Days)"
- Breakdown by rejection reason:
  - "Max positions reached": 45 signals (23%)
  - "Regime unfavorable": 32 signals (16%)
  - "Correlation limit": 28 signals (14%)
  - "Stop loss too wide": 18 signals (9%)
  - "Insufficient capital": 12 signals (6%)
- Drill-down: Click reason to see all signals rejected for that reason
- Recommendation engine: "Consider increasing max positions from 6 to 8 - you're rejecting 23% of signals due to position limits"

### US-004: Paper Trading Signal Validation

**As a trader**, when running in paper trading mode, I want to see hypothetical P&L for rejected signals, so I know if my filters are too strict.

**Acceptance Criteria:**
- In paper trading mode, system simulates "what if we took this rejected signal?"
- Log entry shows:
  - Signal details
  - Rejection reason
  - Hypothetical entry: $60,150
  - Hypothetical stop: $59,500
  - Hypothetical target: $62,000
  - Outcome after 48 hours: "Would have hit Target 1 for +1.8R profit"
- Summary report: "Rejected Signals P&L Analysis"
  - Total rejected signals: 87
  - If taken, would have won: 52 (60% win rate)
  - If taken, would have lost: 35 (40% loss rate)
  - Hypothetical P&L: +$1,240
  - **Insight:** "Max position limit may be too conservative - rejecting profitable signals"

### US-005: Audit Trail Integration

**As a compliance officer**, I want all signal evaluations logged to the immutable audit log, so we have a complete regulatory trail of decision-making.

**Acceptance Criteria:**
- Every signal evaluation creates an audit log entry
- Log includes: Timestamp, Bot ID, Strategy ID, Asset, Signal conditions, Decision, Reason
- Immutable (cannot be deleted or modified)
- Retrievable for regulatory review
- Indexed for fast querying

## 5. Technical Implementation

### Data Model

#### Signal Record
```typescript
interface Signal {
  id: string;
  timestamp: Date;
  botId: string;
  strategyId: string;
  strategyVersion: string;
  asset: string; // "BTC/USDT"
  signalType: "LONG" | "SHORT";

  // Signal Conditions (what triggered it)
  conditions: {
    name: string; // "RSI Oversold"
    value: number; // 28
    threshold: number; // 30
    met: boolean; // true
  }[];

  // Validation Results
  validation: {
    marketRegime: {
      current: string; // "Ranging"
      required: string[]; // ["Ranging", "Low Volatility"]
      passed: boolean;
    };
    strategyEnabled: boolean;
    noConflictingPositions: boolean;
  };

  // Risk Management Results
  riskChecks: {
    capitalAvailable: { value: number; required: number; passed: boolean };
    positionSize: { value: number; max: number; passed: boolean };
    maxPositions: { current: number; max: number; passed: boolean };
    correlationLimit: { correlated: number; max: number; passed: boolean };
    stopLossValid: { distance: number; maxAllowed: number; passed: boolean };
  };

  // Decision
  decision: "ACCEPTED" | "REJECTED";
  rejectionReason?: string;

  // Trade Reference (if accepted)
  tradeId?: string;

  // Market Context (for analysis)
  marketContext: {
    price: number;
    rsi: number;
    adx: number;
    atr: number;
    volume: number;
  };

  // Hypothetical Outcome (for rejected signals in paper trading)
  hypotheticalOutcome?: {
    wouldEnterAt: number;
    wouldStopAt: number;
    wouldTargetAt: number;
    actualOutcome: "HIT_TARGET" | "HIT_STOP" | "PENDING" | "UNKNOWN";
    hypotheticalPnL?: number;
    evaluatedAt?: Date;
  };
}
```

### Database Schema

```sql
CREATE TABLE signals (
  id UUID PRIMARY KEY,
  timestamp TIMESTAMPTZ NOT NULL,
  bot_id UUID NOT NULL REFERENCES bots(id),
  strategy_id UUID NOT NULL,
  strategy_version VARCHAR(20),
  asset VARCHAR(20) NOT NULL,
  signal_type VARCHAR(10) NOT NULL,

  conditions JSONB NOT NULL,
  validation JSONB NOT NULL,
  risk_checks JSONB NOT NULL,

  decision VARCHAR(20) NOT NULL,
  rejection_reason TEXT,

  trade_id UUID REFERENCES trades(id),

  market_context JSONB NOT NULL,
  hypothetical_outcome JSONB,

  created_at TIMESTAMPTZ DEFAULT NOW()
);

CREATE INDEX idx_signals_timestamp ON signals(timestamp DESC);
CREATE INDEX idx_signals_bot ON signals(bot_id, timestamp DESC);
CREATE INDEX idx_signals_decision ON signals(decision, timestamp DESC);
CREATE INDEX idx_signals_asset ON signals(asset, timestamp DESC);
```

### Signal Generation Flow

```typescript
class SignalEvaluator {
  async evaluateStrategy(bot: Bot, marketData: MarketData): Promise<Signal> {
    const signal: Partial<Signal> = {
      id: generateId(),
      timestamp: new Date(),
      botId: bot.id,
      strategyId: bot.strategyId,
      asset: bot.asset,
      conditions: [],
      validation: {},
      riskChecks: {},
      marketContext: extractMarketContext(marketData),
    };

    // Step 1: Check if strategy conditions met
    const strategyConditions = this.checkStrategyConditions(bot.strategy, marketData);
    signal.conditions = strategyConditions;

    if (!this.allConditionsMet(strategyConditions)) {
      // No signal generated (don't log - too noisy)
      return null;
    }

    signal.signalType = this.determineSignalType(strategyConditions);

    // Step 2: Validation checks
    signal.validation = await this.runValidationChecks(bot, marketData);

    if (!signal.validation.allPassed) {
      signal.decision = "REJECTED";
      signal.rejectionReason = this.formatValidationFailure(signal.validation);
      await this.saveSignal(signal);
      await this.logToAudit(signal);
      return signal;
    }

    // Step 3: Risk management checks
    signal.riskChecks = await this.runRiskChecks(bot, marketData);

    if (!signal.riskChecks.allPassed) {
      signal.decision = "REJECTED";
      signal.rejectionReason = this.formatRiskFailure(signal.riskChecks);
      await this.saveSignal(signal);
      await this.logToAudit(signal);
      return signal;
    }

    // Step 4: Signal accepted - execute trade
    signal.decision = "ACCEPTED";
    const trade = await this.executeTrade(bot, signal);
    signal.tradeId = trade.id;

    await this.saveSignal(signal);
    await this.logToAudit(signal);

    return signal;
  }

  private formatRiskFailure(riskChecks): string {
    if (!riskChecks.maxPositions.passed) {
      return `Portfolio limit - Maximum ${riskChecks.maxPositions.max} concurrent positions already open (${riskChecks.maxPositions.current} active)`;
    }
    if (!riskChecks.correlationLimit.passed) {
      return `Correlation limit - Already have ${riskChecks.correlationLimit.correlated} correlated positions (max: ${riskChecks.correlationLimit.max})`;
    }
    if (!riskChecks.stopLossValid.passed) {
      return `Stop loss too wide - ${riskChecks.stopLossValid.distance}% exceeds maximum ${riskChecks.stopLossValid.maxAllowed}%`;
    }
    if (!riskChecks.capitalAvailable.passed) {
      return `Insufficient capital - Need $${riskChecks.capitalAvailable.required}, have $${riskChecks.capitalAvailable.value}`;
    }
    return "Risk check failed";
  }
}
```

### API Endpoints

```typescript
// Get all signals for a bot
GET /api/bots/{botId}/signals?start=2024-10-01&end=2024-10-27&decision=all

// Get signal rejection analytics
GET /api/bots/{botId}/signals/analytics?period=30d

// Get signals for charting
GET /api/bots/{botId}/signals/chart?asset=BTC/USDT&start=...&end=...

// Response format for charting:
{
  signals: [
    {
      timestamp: "2024-10-27T14:35:22Z",
      price: 60150,
      type: "LONG",
      decision: "REJECTED",
      reason: "Max positions reached",
      marker: "yellow"
    },
    {
      timestamp: "2024-10-27T16:22:10Z",
      price: 60050,
      type: "LONG",
      decision: "ACCEPTED",
      tradeId: "trade-123",
      marker: "green"
    }
  ]
}
```

## 6. UI Components

### Chart Integration (FT-136 Enhancement)

Enhance TradingView Lightweight Charts component:

```typescript
// Add signal markers to chart
chart.addMarkers([
  {
    time: '2024-10-27 14:35',
    position: 'belowBar',
    color: '#FFA500', // Orange for rejected
    shape: 'circle',
    text: 'Signal Rejected: Max positions'
  },
  {
    time: '2024-10-27 16:22',
    position: 'belowBar',
    color: '#00FF00', // Green for accepted
    shape: 'arrowUp',
    text: 'Trade Entered'
  }
]);
```

### Signal Log Table

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Timestamp           â”‚ Asset      â”‚ Strategy     â”‚ Type   â”‚ Decision â”‚ Reason                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2024-10-27 16:22:10 â”‚ BTC/USDT   â”‚ Mean Rev v1  â”‚ LONG   â”‚ âœ“ ACCEPT â”‚ Trade executed (#1234)  â”‚
â”‚ 2024-10-27 14:35:22 â”‚ BTC/USDT   â”‚ Mean Rev v1  â”‚ LONG   â”‚ âœ— REJECT â”‚ Max positions (6/6)     â”‚
â”‚ 2024-10-27 12:18:45 â”‚ ETH/USDT   â”‚ Trend v1.2   â”‚ LONG   â”‚ âœ— REJECT â”‚ Regime unfavorable      â”‚
â”‚ 2024-10-27 09:45:33 â”‚ SOL/USDT   â”‚ Momentum v1  â”‚ SHORT  â”‚ âœ— REJECT â”‚ Correlation limit       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

[Click row to expand full details]
```

### Rejection Analytics Dashboard Widget

```
â”Œâ”€ Signal Rejection Analysis (Last 30 Days) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                    â”‚
â”‚  Total Signals Generated: 198                                     â”‚
â”‚  Accepted (Trades): 87 (44%)                                      â”‚
â”‚  Rejected: 111 (56%)                                              â”‚
â”‚                                                                    â”‚
â”‚  Top Rejection Reasons:                                           â”‚
â”‚  â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–‘â–‘  Max Positions (45 signals, 23%)           â”‚
â”‚  â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  Regime Unfavorable (32 signals, 16%)      â”‚
â”‚  â–“â–“â–“â–“â–“â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  Correlation Limit (28 signals, 14%)       â”‚
â”‚  â–“â–“â–“â–“â–“â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘  Stop Too Wide (18 signals, 9%)            â”‚
â”‚                                                                    â”‚
â”‚  ðŸ’¡ Recommendation:                                               â”‚
â”‚  Consider increasing max positions from 6 to 8.                   â”‚
â”‚  You're rejecting 23% of signals due to position limits.          â”‚
â”‚                                                                    â”‚
â”‚  [View Details] [Adjust Limits]                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 7. Performance Considerations

### Noise Reduction

**Problem:** Strategies evaluate conditions every 5-15 minutes. If we log every evaluation, database fills with noise.

**Solution:** Only log when signal is **generated** (conditions met), not every evaluation.

```typescript
// DON'T log this (too noisy):
if (rsi > 30) {
  // No signal, RSI not oversold
  // Don't log anything
}

// DO log this (signal generated):
if (rsi < 30 && priceTouchedBB) {
  // Signal generated! Log regardless of accept/reject
  logSignal({ conditions: [...], decision: ... });
}
```

**Expected Volume:**
- 5 strategies running on 10 assets
- Each generates ~2-5 signals per day
- Total: 100-250 signals/day
- 30 days: 3,000-7,500 records (very manageable)

### Database Indexing

```sql
-- Fast queries for common use cases
CREATE INDEX idx_signals_bot_timestamp ON signals(bot_id, timestamp DESC);
CREATE INDEX idx_signals_decision_timestamp ON signals(decision, timestamp DESC);
CREATE INDEX idx_signals_rejection_reason ON signals(rejection_reason) WHERE decision = 'REJECTED';
```

## 8. Dependencies

- **FT-020 (Audit Logging):** Signal records must be logged to immutable audit trail
- **FT-100 (Bot Management):** Signals are generated by bots executing strategies
- **FT-091 (Risk Management Framework):** Risk checks produce rejection reasons
- **FT-136 (TradingView Charts):** Signals visualized as markers on charts
- **FT-140 (Market Regime Detection):** Regime validation produces rejection reasons
- **FT-060 (Paper Trading):** Hypothetical outcome tracking for rejected signals

## 9. Testing Strategy

### Critical Tests

1. **Signal Generation:**
   - Strategy conditions met â†’ signal logged with decision=PENDING
   - Strategy conditions not met â†’ no signal logged (not noisy)

2. **Rejection Tracking:**
   - Max positions reached â†’ signal rejected with correct reason
   - All rejection reasons properly formatted and logged

3. **Audit Trail:**
   - Every signal creates audit log entry
   - Audit log immutable (cannot modify or delete)

4. **Chart Markers:**
   - Accepted signals show green markers
   - Rejected signals show yellow/orange markers
   - Marker click shows full signal details

5. **Analytics Accuracy:**
   - Rejection breakdown percentages correct
   - Hypothetical P&L calculations accurate (in paper trading)

## 10. Migration Path

### Phase 1: Basic Signal Logging
- Log signal generation with accept/reject decision
- Store in database
- Basic table view in UI

### Phase 2: Chart Integration
- Add signal markers to TradingView charts
- Visual distinction between accepted/rejected
- Click to view details

### Phase 3: Analytics
- Rejection reason breakdown
- Recommendation engine
- Hypothetical P&L for paper trading

### Phase 4: Optimization Tools
- "Replay" rejected signals to test if limits should be adjusted
- A/B testing: "What if I allowed 8 positions instead of 6?"
- ML-based rejection reason optimization

## 11. Success Metrics

- Signal logging latency < 50ms (doesn't slow down trading)
- Database size < 10MB per month (efficient storage)
- Chart loads with 1000+ signals in < 1 second
- Rejection analytics help traders increase accepted signal rate by 10-20%
- Paper trading hypothetical P&L helps validate filters are not too strict

## 12. Open Questions

- Should we log signals for disabled strategies? (Useful for "what if" analysis)
  - **Recommendation:** No, too noisy. Only log when strategy actively enabled.

- How long to retain signal data?
  - **Recommendation:** Keep 6 months in hot storage, archive to cold storage after that

- Should we track "near miss" signals (e.g., RSI = 31, threshold = 30)?
  - **Recommendation:** Phase 2 feature - helpful for sensitivity analysis

- Should rejected signals still reserve capital briefly to avoid double-rejection?
  - **Recommendation:** No - rejection is instantaneous, no capital reservation needed
